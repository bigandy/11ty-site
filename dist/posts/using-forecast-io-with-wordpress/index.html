<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using forecast.io with WordPress - Andrew JD Hudson</title>
    <meta name="Description" content="How to use the WordPress Transients API and wp remote get() to grab the latest weather from the forecast.io API.">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Andrew&#39;s Blog">
    <link rel="preload" href="/assets/fonts/Inter-roman.var.woff2" as="font" type="font/woff2" crossorigin>
	  <link rel="stylesheet" href="/css/styles.css">
  </head>

  <body>
    <header>
	<div class="container">
		<h1 class="home"><a href="/">Andrew&#39;s Blog</a></h1>
		<ul class="nav"><li class="nav-item">
			<a href="/">Home</a>
		</li><li class="nav-item">
			<a href="/about/">About</a>
		</li><li class="nav-item">
			<a href="/posts/">Archive</a>
		</li><li class="nav-item">
			<a href="/cv/">CV</a>
		</li><li class="nav-item">
			<a href="/now/">Now</a>
		</li><li class="nav-item">
			<a href="/design/">Design</a>
		</li></ul>
		<theme-toggle></theme-toggle>

	</div>
</header>


    <main class="tmpl-post">
      <div class="container">
        <h1>Using forecast.io with WordPress</h1>

<div class="tmpl-post__inner">
	
		<p>Posted on: <time class="postlist-date" datetime="2015-10-22">22-10-2015</time></p>
	

	<div class="tmpl-post__content">
		<p>For ages this sites has had the tagline &quot;I'm a front-end and WordPress developer based in <strong>sunny</strong> Oxfordshire. hello!&quot; and I wanted to be able to update the <strong>sunny</strong> with the days weather. How British I know! I am using <a href="https://codex.wordpress.org/Function_Reference/wp_remote_get">wp_remote_get()</a> to grab a <a href="https://developer.forecast.io/docs/v2">JSON object from the forecast.io API</a>, then selecting the part that I want - the current weather - and storing this in my database using <a href="https://codex.wordpress.org/Transients_API">WordPress Transients API</a> to cache the result for 3 hours so that I don't make multiple API calls (and so I don't go over the 1000 API calls per day). I have wrapped the code in a shortcode so that I can call it wherever I like.</p>
<pre><code>function ah_shortcode_weather( $atts, $content ) {
	$response_args = [
		'timeout' =&gt; 120,
	];

	$transient_name = 'weather'; // Name of value in database.
	$cache_time = 3; // Time in hours between updates.

	// If the transient is not set
	if ( false === ( $weather = get_transient( $transient_name ) ) ) {
	   // Get new $response from the weather api
	   $response = wp_remote_get( 'https://api.forecast.io/forecast/APIKEY/LATITUDE,LONGITUDE?units=uk', $response_args );
	   // Check if response is an array
	   if ( is_array( $response ) ) {
			// Get response body
			$response_body = json_decode( $response['body'] );
			// Get Current Weather Summary
			$weather = strtolower( $response_body-&gt;currently-&gt;summary );
			// Set the transient
			set_transient( $transient_name, $weather, 60 * 60 * $cache_time );
		}
	}

	$html = $weather;

	return esc_html( $html );
}

add_shortcode( 'weather', 'ah_shortcode_weather' );
</code></pre>
<p>To use this I call it with the shortcode &quot;weather&quot;. <strong>EDIT:</strong> after a week of using this the weather is almost always &quot;partly cloudy&quot;. Welcome to autumn/winter! **EDIT (19.08.2016) :**Having used this shortcode in the tagline of my site its not very positive displaying the horrible British weather so have removed it from the tagline. You can still find it here: The Weather is currently : [weather]</p>

	</div><p class="post-taglist-label">Tagged: </p>
		<ul class="post-taglist list--inline">
			
					<li>
						<a href="/tags/developing/" class="tag">developing</a>
					</li>
		</ul></div>

<p>
	<a href="/">← Home</a>
</p>

      </div>
    </main>

    <footer>
	<div class="container">
		<p>&copy; 2019 Andrew JD hudson</p>
	</div>
</footer>


    <script>
      // For syntax highlighting only
const html = String.raw;

class ThemeToggle extends HTMLElement {
	constructor() {
		super();

		this.STORAGE_KEY = 'user-color-scheme';
		this.COLOR_MODE_KEY = '--color-mode';
	}

	connectedCallback() {
		this.render();
	}

	getCSSCustomProp(propKey) {
		let response = getComputedStyle(
			document.documentElement
		).getPropertyValue(propKey);

		// Tidy up the string if there’s something to work with
		if (response.length) {
			response = response.replace(/\'|"/g, '').trim();
		}

		// Return the string response by default
		return response;
	}

	applySetting(passedSetting) {
		let currentSetting =
			passedSetting || localStorage.getItem(this.STORAGE_KEY);

		if (currentSetting) {
			document.documentElement.setAttribute(
				'data-user-color-scheme',
				currentSetting
			);
			this.setButtonLabelAndStatus(currentSetting);
		} else {
			this.setButtonLabelAndStatus(
				this.getCSSCustomProp(this.COLOR_MODE_KEY)
			);
		}
	}

	toggleSetting() {
		let currentSetting = localStorage.getItem(this.STORAGE_KEY);

		switch (currentSetting) {
			case null:
				currentSetting =
					this.getCSSCustomProp(this.COLOR_MODE_KEY) === 'dark'
						? 'light'
						: 'dark';
				break;
			case 'light':
				currentSetting = 'dark';
				break;
			case 'dark':
				currentSetting = 'light';
				break;
		}

		localStorage.setItem(this.STORAGE_KEY, currentSetting);

		return currentSetting;
	}

	setButtonLabelAndStatus(currentSetting) {
		this.modeToggleButton.innerText = `${
			currentSetting === 'dark' ? 'Light' : 'Dark'
		} theme`;
		this.modeStatusElement.innerText = `Color mode is now "${currentSetting}"`;
	}

	render() {
		this.innerHTML = html`
			<div class="[ theme-toggle ] [ md:ta-right gap-top-500 ]">
				<div
					role="status"
					class="[ visually-hidden ][ js-mode-status ]"
				></div>
				<button
					class="[ button ] [ font-base text-base weight-bold ] [ js-mode-toggle ]"
				>
					Dark theme
				</button>
			</div>
		`;

		this.afterRender();
	}

	afterRender() {
		this.modeToggleButton = document.querySelector('.js-mode-toggle');
		this.modeStatusElement = document.querySelector('.js-mode-status');

		this.modeToggleButton.addEventListener('click', evt => {
			evt.preventDefault();

			this.applySetting(this.toggleSetting());
		});

		this.applySetting();
	}
}

if ('customElements' in window) {
	customElements.define('theme-toggle', ThemeToggle);
}

    </script>
  </body>
</html>
